name: Import latest warrants daily

on:
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 = 台灣每日 00:00
  workflow_dispatch:

concurrency:
  group: import-latest
  cancel-in-progress: false

jobs:
  import-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Call backend import endpoint
        run: |
          set -e
          URL="${{ secrets.BACKEND_IMPORT_URL }}"
          TOKEN="${{ secrets.BACKEND_IMPORT_TOKEN }}"
          if [ -z "$URL" ]; then
            echo "BACKEND_IMPORT_URL secret is required (e.g. https://twse-warrant-volume-radar.onrender.com/api/warrants/import-latest)"
            exit 1
          fi
          echo "POST $URL"

          AUTH_ARGS=""
          if [ -n "$TOKEN" ]; then
            AUTH_ARGS="-H \"Authorization: Bearer $TOKEN\""
          fi

          # Warm up backend to avoid Render cold-start timeouts
          HEALTH_URL="$URL"
          HEALTH_URL="${HEALTH_URL%/api/warrants/import-latest}/api/health"
          echo "Warm up: $HEALTH_URL"
          eval "curl -sS --max-time 20 $AUTH_ARGS $HEALTH_URL" || true

          # If backend returns { inProgress: true }, wait and retry.
          # Also retry on transient curl timeouts (Render cold start / network).
          ATTEMPTS=6
          for i in $(seq 1 $ATTEMPTS); do
            echo "Attempt $i/$ATTEMPTS"
            rm -f resp.json || true
            # --max-time to avoid hanging forever
            set +e
            HTTP_CODE=$(eval "curl -X POST -sS --max-time 70 $AUTH_ARGS -o resp.json -w \"%{http_code}\" $URL")
            CURL_EXIT=$?
            set -e

            if [ $CURL_EXIT -ne 0 ]; then
              echo "curl failed with exit code $CURL_EXIT"
              echo "### Import latest warrants" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Success**: false" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Message**: curl failed (exit $CURL_EXIT)" >> "$GITHUB_STEP_SUMMARY"
              echo "- **Attempt**: $i/$ATTEMPTS" >> "$GITHUB_STEP_SUMMARY"
              if [ $i -lt $ATTEMPTS ]; then
                echo "Sleeping 20s then retry..."
                sleep 20
                continue
              fi
              exit 1
            fi

            RESP=$(cat resp.json || true)
            echo "$RESP"
            echo "Status: $HTTP_CODE"

            # 409 + inProgress is an expected state: another import is running.
            # Keep waiting/retrying without marking this run as "success".
            if [ "$HTTP_CODE" = "409" ] && echo "$RESP" | grep -q '"inProgress"\s*:\s*true'; then
              echo "Import in progress. Sleeping 15s then retry..."
              sleep 15
              continue
            fi

            if [ "$HTTP_CODE" != "200" ]; then
              echo "Non-200 response from backend"
              if [ $i -lt $ATTEMPTS ]; then
                echo "Sleeping 15s then retry..."
                sleep 15
                continue
              fi
              {
                echo "## Import latest warrants"
                echo "- **Success**: false"
                echo "- **HTTP**: $HTTP_CODE"
                echo "- **Body**: $RESP"
              } >> "$GITHUB_STEP_SUMMARY"
              exit 1
            fi

            # Not in progress -> done (success or failure payload)
            # Parse JSON with jq (available on ubuntu-latest)
            SUCCESS=$(echo "$RESP" | jq -r '.success // false' 2>/dev/null || echo "false")
            MESSAGE=$(echo "$RESP" | jq -r '(.message // .error // "")' 2>/dev/null || echo "")
            IMPORTED=$(echo "$RESP" | jq -r '(.importedCount // "")' 2>/dev/null || echo "")
            TRADE_DATE=$(echo "$RESP" | jq -r '(.tradeDate // "")' 2>/dev/null || echo "")

            {
              echo "## Import latest warrants"
              echo "- **Success**: $SUCCESS"
              [ -n "$MESSAGE" ] && echo "- **Message**: $MESSAGE" || true
              [ -n "$IMPORTED" ] && echo "- **ImportedCount**: $IMPORTED" || true
              [ -n "$TRADE_DATE" ] && echo "- **TradeDate**: $TRADE_DATE" || true
            } >> "$GITHUB_STEP_SUMMARY"

            if [ "$SUCCESS" != "true" ]; then
              echo "Import failed: $MESSAGE"
              exit 1
            fi
            echo "Import success: $MESSAGE"
            exit 0
          done

          echo "Still in progress after retries. Please check backend logs."
          exit 1
